package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.49

import (
	"context"
	"fmt"

	"github.com/FachschaftMathPhysInfo/pepp/server/email"
	"github.com/FachschaftMathPhysInfo/pepp/server/graph/model"
	"github.com/FachschaftMathPhysInfo/pepp/server/models"
	"github.com/google/uuid"
	"github.com/uptrace/bun"
)

// ID is the resolver for the id field.
func (r *buildingResolver) ID(ctx context.Context, obj *models.Building) (string, error) {
	return obj.ID.String(), nil
}

// ID is the resolver for the id field.
func (r *eventResolver) ID(ctx context.Context, obj *models.Event) (string, error) {
	return obj.ID.String(), nil
}

// AssignedTutorsWithRoom is the resolver for the assignedTutorsWithRoom field.
func (r *eventResolver) AssignedTutorsWithRoom(ctx context.Context, obj *models.Event) ([]*model.EventTutorRoomPair, error) {
	var eventToTutorRelations []*models.EventToTutor
	if err := r.DB.NewSelect().
		Model(&eventToTutorRelations).
		Relation("Room").
		Relation("Room.Building").
		Relation("Tutor").
		Where("event_id = ?", obj.ID).
		Scan(ctx); err != nil {
		return nil, err
	}

	roomMap := make(map[string]*model.EventTutorRoomPair)
	for _, eventToTutorRelation := range eventToTutorRelations {
		roomKey := eventToTutorRelation.Room.Number +
			eventToTutorRelation.Room.BuildingID.String()
		if room, exists := roomMap[roomKey]; exists {
			room.Tutors = append(room.Tutors, eventToTutorRelation.Tutor)
		} else {
			roomMap[roomKey] = &model.EventTutorRoomPair{
				Tutors: []*models.Tutor{eventToTutorRelation.Tutor},
				Room:   eventToTutorRelation.Room,
			}
		}
	}

	var tutorRoomPairs []*model.EventTutorRoomPair
	for _, tutorRoomPair := range roomMap {
		tutorRoomPairs = append(tutorRoomPairs, tutorRoomPair)
	}

	return tutorRoomPairs, nil
}

// AddRegistration is the resolver for the addRegistration field.
func (r *mutationResolver) AddRegistration(ctx context.Context, student model.NewStudent) (string, error) {
	panic(fmt.Errorf("not implemented: AddRegistration - addRegistration"))
}

// UpdateStudentAcceptedStatus is the resolver for the updateStudentAcceptedStatus field.
func (r *mutationResolver) UpdateStudentAcceptedStatus(ctx context.Context, studentMail string, accepted bool) (string, error) {
	panic(fmt.Errorf("not implemented: UpdateStudentAcceptedStatus - updateStudentAcceptedStatus"))
}

// AddTutor is the resolver for the addTutor field.
func (r *mutationResolver) AddTutor(ctx context.Context, tutor models.Tutor) (string, error) {
	tutor.SessionID = uuid.New()
	if _, err := r.DB.NewInsert().
		Model(&tutor).
		Exec(ctx); err != nil {
		return "Failed to add tutor", err
	}

	if err := email.SendConfirmation(tutor.User); err != nil {
		return "Failed to send confirmation mail", err
	}

	return "Successfully added new Tutor", nil
}

// UpdateTutor is the resolver for the updateTutor field.
func (r *mutationResolver) UpdateTutor(ctx context.Context, tutorMail string, tutor models.Tutor) (string, error) {
	panic(fmt.Errorf("not implemented: UpdateTutor - updateTutor"))
}

// AddEvent is the resolver for the addEvent field.
func (r *mutationResolver) AddEvent(ctx context.Context, event models.Event) (string, error) {
	if _, err := r.DB.NewInsert().
		Model(&event).
		Exec(ctx); err != nil {
		return "Failed to insert the event", err
	}

	return "Successfully inserted new event", nil
}

// UpdateEvent is the resolver for the updateEvent field.
func (r *mutationResolver) UpdateEvent(ctx context.Context, eventID string, event models.Event) (string, error) {
	panic(fmt.Errorf("not implemented: UpdateEvent - updateEvent"))
}

// AddBuilding is the resolver for the addBuilding field.
func (r *mutationResolver) AddBuilding(ctx context.Context, building models.Building) (string, error) {
	if _, err := r.DB.NewInsert().
		Model(&building).
		Exec(ctx); err != nil {
		return "Failed to insert building", err
	}

	return "Successfully inserted new building", nil
}

// AddRoom is the resolver for the addRoom field.
func (r *mutationResolver) AddRoom(ctx context.Context, room models.Room) (string, error) {
	if _, err := r.DB.NewInsert().
		Model(&room).
		Exec(ctx); err != nil {
		return "Failed to insert room", err
	}

	return "Successfully inserted new room", nil
}

// UpdateBuilding is the resolver for the updateBuilding field.
func (r *mutationResolver) UpdateBuilding(ctx context.Context, buildingID string, building models.Building) (string, error) {
	panic(fmt.Errorf("not implemented: UpdateBuilding - updateBuilding"))
}

// AddTopic is the resolver for the addTopic field.
func (r *mutationResolver) AddTopic(ctx context.Context, topic models.Topic) (string, error) {
	if _, err := r.DB.NewInsert().
		Model(&topic).
		Exec(ctx); err != nil {
		return "Failed to insert topic", err
	}

	return "Successfully inserted new topic", nil
}

// LinkAvailableRoomToEvent is the resolver for the linkAvailableRoomToEvent field.
func (r *mutationResolver) LinkAvailableRoomToEvent(ctx context.Context, link models.EventToRoom) (string, error) {
	if _, err := r.DB.NewInsert().
		Model(&link).
		Exec(ctx); err != nil {
		return "Failed to link room to event", err
	}

	return "Successfully linked room to event", nil
}

// LinkTutorToEventAndRoom is the resolver for the linkTutorToEventAndRoom field.
func (r *mutationResolver) LinkTutorToEventAndRoom(ctx context.Context, link models.EventToTutor) (string, error) {
	res, err := r.DB.NewDelete().
		Model((*models.UserToEvent)(nil)).
		Where("user_mail = ?", link.TutorMail).
		Exec(ctx)
	if err != nil {
		return "", err
	}

	rowsAffected, _ := res.RowsAffected()
	if rowsAffected == 0 {
		return "", fmt.Errorf("Tutor is not available for this event")
	}

	if _, err := r.DB.NewInsert().
		Model(&link).
		Exec(ctx); err != nil {
		return "Failed to link tutor to event and room", err
	}

	return "Successfully linked tutor to event and room", nil
}

// Students is the resolver for the students field.
func (r *queryResolver) Students(ctx context.Context, mail []string) ([]*model.Student, error) {
	panic(fmt.Errorf("not implemented: Students - students"))
}

// Tutors is the resolver for the tutors field.
func (r *queryResolver) Tutors(ctx context.Context, mail []string, eventID *string) ([]*models.Tutor, error) {
	var tutors []*models.Tutor

	query := r.DB.NewSelect().
		Model(&tutors).
		Relation("Events")

	if eventID != nil {
		if err := uuid.Validate(*eventID); err != nil {
			return nil, err
		}

		query = query.
			Relation("EventsAssigned").
			Where("event_id = ?", *eventID)
	}

	if mail != nil {
		query = query.Where("mail IN (?)", bun.In(mail))
	}

	if err := query.Scan(ctx); err != nil {
		return nil, err
	}

	return tutors, nil
}

// Events is the resolver for the events field.
func (r *queryResolver) Events(ctx context.Context, id []string, topic []string) ([]*models.Event, error) {
	var events []*models.Event

	query := r.DB.NewSelect().
		Model(&events).
		Relation("Topic").
		Relation("AssignedTutorsWithRoom").
		Relation("AvailableTutors").
		Relation("RoomsAvailable")

	if topic != nil {
		query = query.Where("topic_name IN (?)", bun.In(topic))
	}

	if id != nil {
		for _, uid := range id {
			if err := uuid.Validate(uid); err != nil {
				return nil, err
			}
		}

		query = query.Where("id IN (?)", bun.In(id))
	}

	if err := query.Scan(ctx); err != nil {
		return nil, err
	}

	return events, nil
}

// Buildings is the resolver for the buildings field.
func (r *queryResolver) Buildings(ctx context.Context, id []string) ([]*models.Building, error) {
	var buildings []*models.Building

	query := r.DB.NewSelect().
		Model(&buildings).
		Relation("Rooms")

	if id != nil {
		for _, uid := range id {
			if err := uuid.Validate(uid); err != nil {
				return nil, err
			}
		}

		query = query.Where("id IN (?)", bun.In(id))
	}

	if err := query.Scan(ctx); err != nil {
		return nil, err
	}

	return buildings, nil
}

// Rooms is the resolver for the rooms field.
func (r *queryResolver) Rooms(ctx context.Context, number []string, buildingID string) ([]*models.Room, error) {
	var rooms []*models.Room

	query := r.DB.NewSelect().
		Model(&rooms).
		Relation("Building").
		Where("building_id = ?", buildingID)

	if number != nil {
		query = query.Where("number IN (?)", bun.In(number))
	}

	if err := query.Scan(ctx); err != nil {
		return nil, err
	}

	return rooms, nil
}

// Topics is the resolver for the topics field.
func (r *queryResolver) Topics(ctx context.Context, name []string) ([]*models.Topic, error) {
	var topics []*models.Topic

	query := r.DB.NewSelect().
		Model(&topics).
		Relation("Building")

	if name != nil {
		query = query.Where("name IN (?)", bun.In(name))
	}

	if err := query.Scan(ctx); err != nil {
		return nil, err
	}

	return topics, nil
}

// EventsAvailable is the resolver for the eventsAvailable field.
func (r *tutorResolver) EventsAvailable(ctx context.Context, obj *models.Tutor) ([]*models.Event, error) {
	var events []*models.Event
	for _, event := range obj.Events {
		events = append(events, &event)
	}

	return events, nil
}

// EventID is the resolver for the eventID field.
func (r *newEventToTutorLinkResolver) EventID(ctx context.Context, obj *models.EventToTutor, data string) error {
	id, err := uuid.Parse(data)
	if err != nil {
		return err
	}

	obj.EventID = id
	return nil
}

// BuildingID is the resolver for the buildingID field.
func (r *newEventToTutorLinkResolver) BuildingID(ctx context.Context, obj *models.EventToTutor, data string) error {
	id, err := uuid.Parse(data)
	if err != nil {
		return err
	}

	obj.RoomBuildingID = id
	return nil
}

// BuildingID is the resolver for the BuildingID field.
func (r *newRoomResolver) BuildingID(ctx context.Context, obj *models.Room, data string) error {
	id, err := uuid.Parse(data)
	if err != nil {
		return err
	}

	obj.BuildingID = id
	return nil
}

// EventID is the resolver for the eventID field.
func (r *newRoomToEventLinkResolver) EventID(ctx context.Context, obj *models.EventToRoom, data string) error {
	id, err := uuid.Parse(data)
	if err != nil {
		return err
	}

	obj.EventID = id
	return nil
}

// BuildingID is the resolver for the buildingID field.
func (r *newRoomToEventLinkResolver) BuildingID(ctx context.Context, obj *models.EventToRoom, data string) error {
	id, err := uuid.Parse(data)
	if err != nil {
		return err
	}

	obj.EventID = id
	return nil
}

// EventsAvailable is the resolver for the eventsAvailable field.
func (r *newTutorResolver) EventsAvailable(ctx context.Context, obj *models.Tutor, data []string) error {
	var tutorToEventRelations []*models.UserToEvent
	for _, id := range data {
		eventID, err := uuid.Parse(id)
		if err != nil {
			return err
		}

		tutorToEventRelation := &models.UserToEvent{
			UserMail: obj.Mail,
			EventID:  eventID,
		}

		tutorToEventRelations = append(tutorToEventRelations, tutorToEventRelation)
	}

	for _, relation := range tutorToEventRelations {
		if _, err := r.DB.NewInsert().Model(relation).Exec(ctx); err != nil {
			return err
		}
	}

	return nil
}

// Building returns BuildingResolver implementation.
func (r *Resolver) Building() BuildingResolver { return &buildingResolver{r} }

// Event returns EventResolver implementation.
func (r *Resolver) Event() EventResolver { return &eventResolver{r} }

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

// Query returns QueryResolver implementation.
func (r *Resolver) Query() QueryResolver { return &queryResolver{r} }

// Tutor returns TutorResolver implementation.
func (r *Resolver) Tutor() TutorResolver { return &tutorResolver{r} }

// NewEventToTutorLink returns NewEventToTutorLinkResolver implementation.
func (r *Resolver) NewEventToTutorLink() NewEventToTutorLinkResolver {
	return &newEventToTutorLinkResolver{r}
}

// NewRoom returns NewRoomResolver implementation.
func (r *Resolver) NewRoom() NewRoomResolver { return &newRoomResolver{r} }

// NewRoomToEventLink returns NewRoomToEventLinkResolver implementation.
func (r *Resolver) NewRoomToEventLink() NewRoomToEventLinkResolver {
	return &newRoomToEventLinkResolver{r}
}

// NewTutor returns NewTutorResolver implementation.
func (r *Resolver) NewTutor() NewTutorResolver { return &newTutorResolver{r} }

type buildingResolver struct{ *Resolver }
type eventResolver struct{ *Resolver }
type mutationResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }
type tutorResolver struct{ *Resolver }
type newEventToTutorLinkResolver struct{ *Resolver }
type newRoomResolver struct{ *Resolver }
type newRoomToEventLinkResolver struct{ *Resolver }
type newTutorResolver struct{ *Resolver }
